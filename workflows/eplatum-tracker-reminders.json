{
  "name": "Eplatum Tracker Reminders",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "id": "cron-node",
      "name": "Cron (every 30min)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT u.*, r.id as reminder_id, r.next_at as reminder_next_at\nFROM users u\nINNER JOIN reminders r ON u.tg_user_id = r.tg_user_id\nWHERE (u.snoozed_until IS NULL OR u.snoozed_until < now())\n  AND r.next_at <= now()\n  AND r.kind = 'nudge'\nORDER BY r.next_at ASC\nLIMIT 100;"
      },
      "id": "select-users-node",
      "name": "Select Users for Reminders",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        200,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_SUPABASE_CREDENTIALS_ID",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format reminder message based on nudge level\nconst item = $input.item.json;\nconst nudgeLevel = item.nudge_level || 'medium';\nconst currentStep = item.current_step || 1;\nconst totalSteps = 7;\n\nlet reminderText = '';\n\nif (currentStep <= totalSteps) {\n  const questions = [\n    null,\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: Ð§Ñ‚Ð¾ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ? (Ñ€Ð°Ð±Ð¾Ñ‚Ð°/Ð±Ð¸Ð·Ð½ÐµÑ/Ð¶Ð¸Ð·Ð½ÑŒ/Ð´ÐµÐ½ÑŒÐ³Ð¸/ÑÐ¼Ñ‹ÑÐ»)',\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: ÐšÐ°ÐºÐ¸Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ? (Ð²Ñ€ÐµÐ¼Ñ Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ, Ð´ÐµÐ½ÑŒÐ³Ð¸ Ð½Ð° ÑÑ‚Ð°Ñ€Ñ‚, ÑÐ·Ñ‹Ðº, ÑÑ‚Ñ€Ð°Ð½Ð°/Ð³Ð¾Ñ€Ð¾Ð´)',\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: Ð§Ñ‚Ð¾ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ Ð½Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ? (3 Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸/Ñ‚ÐµÐ¼Ñ‹)',\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: Ð§Ñ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ? (3 Ð½Ð°Ð²Ñ‹ÐºÐ°/Ð¾Ð¿Ñ‹Ñ‚Ð°)',\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: ÐšÐ°ÐºÐ¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚? (Ð½Ð°Ð¹Ð¼/Ñ„Ñ€Ð¸Ð»Ð°Ð½Ñ/ÑÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚/ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚/ÐºÐ¾Ð½ÑÐ°Ð»Ñ‚Ð¸Ð½Ð³/Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð¸Ð·Ð½ÐµÑ)',\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: Ð Ð¸ÑÐº/Ñ‚ÐµÐ¼Ð¿? (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾/Ð±Ñ‹ÑÑ‚Ñ€Ð¾/Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð¾)',\n    'ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÑƒÑÐ¿ÐµÑ…Ð° Ð½Ð° 30 Ð´Ð½ÐµÐ¹? (Ñ‡Ñ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ \"Ð¿Ð¾Ð±ÐµÐ´Ð¾Ð¹\")'\n  ];\n  \n  reminderText = `ðŸ’­ ${questions[currentStep] || 'ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ð¼?'}`;\n} else {\n  reminderText = 'âœ… ÐžÐ½Ð±Ð¾Ñ€Ð´Ð¸Ð½Ð³ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!\\n\\nðŸŽ¯ Ð’Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑˆÐ°Ð³Ð°. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ /status Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°.';\n}\n\n// Adjust tone by nudge level\nif (nudgeLevel === 'high') {\n  reminderText = `âš¡ ${reminderText}`;\n} else if (nudgeLevel === 'low') {\n  reminderText = `ðŸ‘‹ ${reminderText}`;\n}\n\n// Calculate next reminder time\nconst nudgeHours = nudgeLevel === 'low' ? 48 : (nudgeLevel === 'high' ? 8 : 24);\nconst nextNudgeAt = new Date(Date.now() + nudgeHours * 60 * 60 * 1000).toISOString();\n\n// Respect timezone - don't send during night (22:00-08:00)\nconst tz = item.timezone || 'Europe/Warsaw';\nconst now = new Date();\nconst localHour = new Date(now.toLocaleString('en-US', { timeZone: tz })).getHours();\n\nif (localHour >= 22 || localHour < 8) {\n  // Schedule for morning (08:00 local time)\n  const tomorrow = new Date(now);\n  tomorrow.setDate(tomorrow.getDate() + 1);\n  tomorrow.setHours(8, 0, 0, 0);\n  nextNudgeAt = tomorrow.toISOString();\n}\n\nreturn {\n  ...item,\n  reminderText,\n  nextNudgeAt\n};"
      },
      "id": "format-reminder-node",
      "name": "Format Reminder",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        0
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.tg_chat_id }}",
        "text": "={{ $json.reminderText }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-reminder-node",
      "name": "Send Reminder",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        600,
        0
      ],
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_TELEGRAM_CREDENTIALS_ID",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE reminders\nSET next_at = '{{ $json.nextNudgeAt }}',\n    last_sent_at = now(),\n    updated_at = now()\nWHERE id = '{{ $json.reminder_id }}';"
      },
      "id": "update-reminder-next-node",
      "name": "Update Reminder Next",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        800,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_SUPABASE_CREDENTIALS_ID",
          "name": "Supabase"
        }
      }
    }
  ],
  "connections": {
    "Cron (every 30min)": {
      "main": [
        [
          {
            "node": "Select Users for Reminders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Users for Reminders": {
      "main": [
        [
          {
            "node": "Format Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Reminder": {
      "main": [
        [
          {
            "node": "Send Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reminder": {
      "main": [
        [
          {
            "node": "Update Reminder Next",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "timezone": "Europe/Warsaw"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "active": false
}
